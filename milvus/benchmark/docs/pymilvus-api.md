# PyMilvus API ä¸ DiskANN å‚æ•°æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç» PyMilvus çš„åŸºæœ¬ API ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠ DiskANN ç´¢å¼•çš„å‚æ•°é…ç½®ä¸è°ƒä¼˜ã€‚

---

## ç›®å½•

1. [PyMilvus åŸºç¡€ API](#1-pymilvus-åŸºç¡€-api)
2. [DiskANN ç´¢å¼•ä»‹ç»](#2-diskann-ç´¢å¼•ä»‹ç»)
3. [DiskANN å‚æ•°è¯¦è§£](#3-diskann-å‚æ•°è¯¦è§£)
4. [search_list æ·±åº¦è§£æ](#4-search_list-æ·±åº¦è§£æ)
5. [å‚æ•°è°ƒä¼˜æŒ‡å—](#5-å‚æ•°è°ƒä¼˜æŒ‡å—)
6. [å®Œæ•´ç¤ºä¾‹](#6-å®Œæ•´ç¤ºä¾‹)

---

## 1. PyMilvus åŸºç¡€ API

### 1.1 å®‰è£…

```bash
pip install pymilvus
```

### 1.2 è¿æ¥ Milvus

```python
from pymilvus import MilvusClient

# æ–¹å¼1: è¿æ¥ Milvus Standalone/Cluster
client = MilvusClient(uri="http://localhost:19530")

# æ–¹å¼2: ä½¿ç”¨ Milvus Lite (æœ¬åœ°åµŒå…¥å¼)
client = MilvusClient(uri="./milvus_lite.db")

# è·å–æœåŠ¡å™¨ç‰ˆæœ¬
print(client.get_server_version())
```

### 1.3 åˆ›å»º Collection

```python
from pymilvus import DataType

# åˆ›å»º Schema
schema = client.create_schema(
    auto_id=False,           # æ‰‹åŠ¨æŒ‡å®š ID
    enable_dynamic_field=False  # ç¦ç”¨åŠ¨æ€å­—æ®µ
)

# æ·»åŠ å­—æ®µ
schema.add_field(
    field_name="id",
    datatype=DataType.INT64,
    is_primary=True          # ä¸»é”®
)
schema.add_field(
    field_name="vector",
    datatype=DataType.FLOAT_VECTOR,
    dim=128                  # å‘é‡ç»´åº¦
)
schema.add_field(
    field_name="text",
    datatype=DataType.VARCHAR,
    max_length=512           # å¯é€‰: æ–‡æœ¬å­—æ®µ
)

# åˆ›å»ºç´¢å¼•å‚æ•°
index_params = client.prepare_index_params()
index_params.add_index(
    field_name="vector",
    index_type="DISKANN",    # ç´¢å¼•ç±»å‹
    metric_type="L2",        # è·ç¦»ç±»å‹
    index_name="vector_index"
)

# åˆ›å»º Collection
client.create_collection(
    collection_name="my_collection",
    schema=schema,
    index_params=index_params
)
```

### 1.4 æ’å…¥æ•°æ®

```python
import numpy as np

# å‡†å¤‡æ•°æ®
data = [
    {"id": i, "vector": np.random.random(128).tolist(), "text": f"doc_{i}"}
    for i in range(1000)
]

# æ’å…¥
client.insert(collection_name="my_collection", data=data)

# åˆ·æ–° (ç¡®ä¿æ•°æ®æŒä¹…åŒ–)
client.flush(collection_name="my_collection")
```

### 1.5 åŠ è½½ä¸é‡Šæ”¾

```python
# åŠ è½½ Collection åˆ°å†…å­˜ (æœç´¢å‰å¿…é¡»)
client.load_collection(collection_name="my_collection")

# é‡Šæ”¾ Collection (é‡Šæ”¾å†…å­˜)
client.release_collection(collection_name="my_collection")
```

### 1.6 å‘é‡æœç´¢

```python
# æŸ¥è¯¢å‘é‡
query_vector = np.random.random(128).tolist()

# æœç´¢å‚æ•°
search_params = {
    "metric_type": "L2",
    "params": {
        "search_list": 150  # DiskANN ç‰¹æœ‰å‚æ•°
    }
}

# æ‰§è¡Œæœç´¢
results = client.search(
    collection_name="my_collection",
    data=[query_vector],     # æ”¯æŒæ‰¹é‡æŸ¥è¯¢
    limit=10,                # Top-K
    search_params=search_params,
    output_fields=["text"]   # è¿”å›çš„å­—æ®µ
)

# è§£æç»“æœ
for hits in results:
    for hit in hits:
        print(f"ID: {hit['id']}, Distance: {hit['distance']}, Text: {hit['entity']['text']}")
```

### 1.7 åˆ é™¤ä¸æ¸…ç†

```python
# åˆ é™¤æ•°æ®
client.delete(
    collection_name="my_collection",
    filter="id in [1, 2, 3]"  # åˆ é™¤æ¡ä»¶
)

# åˆ é™¤ Collection
client.drop_collection(collection_name="my_collection")

# å…³é—­è¿æ¥
client.close()
```

---

## 2. DiskANN ç´¢å¼•ä»‹ç»

### 2.1 ä»€ä¹ˆæ˜¯ DiskANN

**DiskANN** (Disk-based Approximate Nearest Neighbor) æ˜¯å¾®è½¯ç ”ç©¶é™¢å¼€å‘çš„ä¸€ç§**åŸºäºç£ç›˜çš„å‘é‡ç´¢å¼•ç®—æ³•**ï¼Œä¸“ä¸ºå¤§è§„æ¨¡å‘é‡æ£€ç´¢è®¾è®¡ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**:
- ğŸ“€ **ç£ç›˜ä¼˜åŒ–**: å°†ç´¢å¼•å­˜å‚¨åœ¨ SSD ä¸Šï¼Œçªç ´å†…å­˜é™åˆ¶
- ğŸš€ **åäº¿çº§æ”¯æŒ**: å¯å¤„ç† 1B+ å‘é‡
- âš¡ **é«˜æ€§èƒ½**: åˆ©ç”¨ NVMe SSD å®ç°ä½å»¶è¿Ÿæœç´¢
- ğŸ¯ **é«˜å¬å›ç‡**: é€šå¸¸ > 95%

### 2.2 DiskANN å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DiskANN æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚   PQ å‹ç¼©    â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  å†…å­˜ç´¢å¼•å›¾   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  å€™é€‰é›†åˆ   â”‚ â”‚
â”‚   â”‚  (Product    â”‚       â”‚  (Vamana     â”‚       â”‚ (Candidate  â”‚ â”‚
â”‚   â”‚  Quantization)â”‚       â”‚   Graph)     â”‚       â”‚   List)     â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                      â”‚                      â”‚        â”‚
â”‚          â–¼                      â–¼                      â–¼        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚   SSD å­˜å‚¨   â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚  ç²¾ç¡®å‘é‡    â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ æœ€ç»ˆç»“æœ    â”‚ â”‚
â”‚   â”‚  (Full       â”‚       â”‚  (Rerank)    â”‚       â”‚ (Top-K)     â”‚ â”‚
â”‚   â”‚   Vectors)   â”‚       â”‚              â”‚       â”‚             â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœç´¢æµç¨‹**:
1. **PQ å‹ç¼©è·ç¦»è®¡ç®—**: ä½¿ç”¨å‹ç¼©å‘é‡å¿«é€Ÿç­›é€‰å€™é€‰
2. **å›¾éå†**: åœ¨ Vamana å›¾ä¸Šè¿›è¡Œè´ªå¿ƒæœç´¢
3. **SSD è¯»å–**: ä»ç£ç›˜è¯»å–å®Œæ•´å‘é‡
4. **ç²¾æ’ (Rerank)**: ç”¨åŸå§‹å‘é‡è®¡ç®—ç²¾ç¡®è·ç¦»
5. **è¿”å› Top-K**: è¾“å‡ºæœ€ç»ˆç»“æœ

### 2.3 é€‚ç”¨åœºæ™¯

| åœºæ™¯ | æ˜¯å¦é€‚åˆ | è¯´æ˜ |
|------|---------|------|
| å‘é‡æ•° > 100M | âœ… éå¸¸é€‚åˆ | DiskANN æ ¸å¿ƒä¼˜åŠ¿ |
| å‘é‡æ•° < 1M | âš ï¸ å¯é€‰ | HNSW å¯èƒ½æ›´å¿« |
| å†…å­˜å—é™ | âœ… éå¸¸é€‚åˆ | å¤§éƒ¨åˆ†æ•°æ®åœ¨ SSD |
| å®æ—¶æ€§è¦æ±‚æé«˜ | âš ï¸ éœ€æƒè¡¡ | SSD I/O æœ‰å¼€é”€ |
| é«˜ç»´å‘é‡ (>512) | âœ… é€‚åˆ | PQ å‹ç¼©æ•ˆæœå¥½ |

---

## 3. DiskANN å‚æ•°è¯¦è§£

### 3.1 ç´¢å¼•æ„å»ºå‚æ•°

åœ¨åˆ›å»ºç´¢å¼•æ—¶å¯æŒ‡å®š:

```python
index_params.add_index(
    field_name="vector",
    index_type="DISKANN",
    metric_type="L2",
    params={
        # ç´¢å¼•æ„å»ºå‚æ•° (å¯é€‰)
    }
)
```

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `metric_type` | - | è·ç¦»ç±»å‹: `L2`, `IP`, `COSINE` |

**è·ç¦»ç±»å‹è¯´æ˜**:

| ç±»å‹ | å…¨ç§° | å…¬å¼ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| `L2` | æ¬§æ°è·ç¦» | $\sqrt{\sum(a_i - b_i)^2}$ | å›¾åƒã€SIFT ç‰¹å¾ |
| `IP` | å†…ç§¯ | $\sum a_i \times b_i$ | å½’ä¸€åŒ–å‘é‡ã€è¯­ä¹‰ç›¸ä¼¼åº¦ |
| `COSINE` | ä½™å¼¦ç›¸ä¼¼åº¦ | $\frac{A \cdot B}{\|A\| \|B\|}$ | æ–‡æœ¬åµŒå…¥ã€æ¨èç³»ç»Ÿ |

### 3.2 æœç´¢å‚æ•°

æœç´¢æ—¶æŒ‡å®š:

```python
search_params = {
    "metric_type": "L2",
    "params": {
        "search_list": 150  # ğŸ”‘ æ ¸å¿ƒå‚æ•°
    }
}
```

| å‚æ•° | ç±»å‹ | èŒƒå›´ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| `search_list` | int | [topK, 65535] | 16 | æœç´¢æ—¶çš„å€™é€‰åˆ—è¡¨å¤§å° |

---

## 4. search_list æ·±åº¦è§£æ

### 4.1 ä»€ä¹ˆæ˜¯ search_list

`search_list` æ˜¯ DiskANN æœç´¢è¿‡ç¨‹ä¸­**ç»´æŠ¤çš„å€™é€‰å‘é‡é˜Ÿåˆ—å¤§å°**ï¼Œå®ƒç›´æ¥æ§åˆ¶äº†æœç´¢çš„**å¹¿åº¦**å’Œ**ç²¾åº¦**ã€‚

**ç±»æ¯”ç†è§£**:
- æƒ³è±¡åœ¨è¿·å®«ä¸­æ‰¾æœ€çŸ­è·¯å¾„
- `search_list` å°±æ˜¯ä½ åŒæ—¶è®°ä½çš„"å¯èƒ½æ­£ç¡®çš„å²”è·¯å£"æ•°é‡
- è®°ä½çš„è¶Šå¤šï¼Œæ‰¾åˆ°æœ€ä¼˜è·¯å¾„çš„æ¦‚ç‡è¶Šé«˜ï¼Œä½†è€—æ—¶ä¹Ÿè¶Šé•¿

### 4.2 search_list å·¥ä½œæœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    search_list å·¥ä½œæµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Query Vector                                                      â”‚
â”‚        â”‚                                                            â”‚
â”‚        â–¼                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                  Vamana Graph éå†                       â”‚      â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   ...  â”Œâ”€â”€â”€â”    â”‚      â”‚
â”‚   â”‚  â”‚ 1 â”‚â”€â”€â–¶â”‚ 2 â”‚â”€â”€â–¶â”‚ 3 â”‚â”€â”€â–¶â”‚ 4 â”‚â”€â”€â–¶â”‚ 5 â”‚  ...  â”‚ N â”‚    â”‚      â”‚
â”‚   â”‚  â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜        â””â”€â”€â”€â”˜    â”‚      â”‚
â”‚   â”‚    â”‚       â”‚       â”‚       â”‚       â”‚            â”‚       â”‚      â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚      â”‚
â”‚   â”‚                        â”‚                                 â”‚      â”‚
â”‚   â”‚                        â–¼                                 â”‚      â”‚
â”‚   â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚      â”‚
â”‚   â”‚           â”‚     Candidate List      â”‚                   â”‚      â”‚
â”‚   â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                   â”‚      â”‚
â”‚   â”‚           â”‚  â”‚  size = search_list  â”‚  â”‚ â—€â”€â”€ æ ¸å¿ƒå‚æ•°    â”‚      â”‚
â”‚   â”‚           â”‚  â”‚  [v1, v2, ..., vN]â”‚  â”‚                   â”‚      â”‚
â”‚   â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                   â”‚      â”‚
â”‚   â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                        â”‚                                            â”‚
â”‚                        â–¼                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚              ä» SSD è¯»å–å®Œæ•´å‘é‡ (Rerank)                 â”‚      â”‚
â”‚   â”‚           å–å‰ TopK ä¸ªä½œä¸ºæœ€ç»ˆç»“æœ                        â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                        â”‚                                            â”‚
â”‚                        â–¼                                            â”‚
â”‚                  Final Results                                      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 search_list ä¸æ€§èƒ½çš„å…³ç³»

**æ ¸å¿ƒå…¬å¼**:

$$
\text{Recall} \propto \log(\text{search\_list})
$$

$$
\text{Latency} \propto \text{search\_list}
$$

**å®é™…å½±å“**:

| search_list | å€™é€‰å‘é‡æ•° | å¬å›ç‡ | QPS | å»¶è¿Ÿ |
|-------------|-----------|--------|-----|------|
| å° (50-100) | å°‘ | è¾ƒä½ (~98%) | é«˜ | ä½ |
| ä¸­ (100-200) | é€‚ä¸­ | é«˜ (~99%) | ä¸­ | ä¸­ |
| å¤§ (200-500) | å¤š | å¾ˆé«˜ (~99.9%) | ä½ | é«˜ |

### 4.4 search_list å¯¹ GIST-960 çš„å®æµ‹å½±å“

æ¥è‡ªæˆ‘ä»¬çš„æµ‹è¯•æ•°æ®:

| search_list | QPS | Recall@100 | QPS ç›¸å¯¹å˜åŒ– |
|-------------|-----|------------|-------------|
| 100 | 9.66 | 99.92% | åŸºå‡† |
| 150 | 6.25 | 99.97% | -35% |
| 200 | 5.13 | 99.97% | -47% |
| 300 | 3.16 | 99.98% | -67% |

**å¯è§†åŒ–**:

```
QPS
 10 â”¤ â—
  8 â”¤   â•²
  6 â”¤     â—
  5 â”¤       â—
  4 â”¤         â•²
  3 â”¤           â—
  2 â”¤
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       100  150  200  300  â†’ search_list
```

### 4.5 search_list æœ€ä½³å®è·µ

**é€‰æ‹©åŸåˆ™**:

```python
# 1. å¿…é¡» >= TopK
search_list = max(topK, desired_list_size)

# 2. æ¨èå…¬å¼
search_list = topK * 1.5  # å¹³è¡¡æ–¹æ¡ˆ
search_list = topK * 2    # é«˜å¬å›ç‡æ–¹æ¡ˆ
search_list = topK        # é«˜æ€§èƒ½æ–¹æ¡ˆ
```

**åœºæ™¯å»ºè®®**:

| åœºæ™¯ | æ¨è search_list | è¯´æ˜ |
|------|-----------------|------|
| å®æ—¶æ¨è | TopK ~ 1.2Ã—TopK | ä½å»¶è¿Ÿä¼˜å…ˆ |
| è¯­ä¹‰æœç´¢ | 1.5Ã—TopK ~ 2Ã—TopK | å¹³è¡¡ |
| é«˜ç²¾åº¦æ£€ç´¢ | 2Ã—TopK ~ 3Ã—TopK | å¬å›ç‡ä¼˜å…ˆ |
| RAG åº”ç”¨ | 1.5Ã—TopK | æ¨è |

**ä»£ç ç¤ºä¾‹**:

```python
def get_search_params(topK: int, priority: str = "balanced") -> dict:
    """æ ¹æ®ä¼˜å…ˆçº§ç”Ÿæˆæœç´¢å‚æ•°"""
    multipliers = {
        "speed": 1.0,      # é€Ÿåº¦ä¼˜å…ˆ
        "balanced": 1.5,   # å¹³è¡¡
        "recall": 2.5      # å¬å›ç‡ä¼˜å…ˆ
    }
    
    search_list = int(topK * multipliers.get(priority, 1.5))
    search_list = max(search_list, topK)  # ç¡®ä¿ >= topK
    
    return {
        "metric_type": "L2",
        "params": {"search_list": search_list}
    }

# ä½¿ç”¨
params = get_search_params(topK=100, priority="balanced")  # search_list=150
```

---

## 5. å‚æ•°è°ƒä¼˜æŒ‡å—

### 5.1 æ€§èƒ½è°ƒä¼˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DiskANN è°ƒä¼˜æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚   Step 1: ç¡®å®šç›®æ ‡                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  éœ€è¦å¤šé«˜çš„å¬å›ç‡? (95%? 99%? 99.9%?)                â”‚    â”‚
â”‚   â”‚  å¯æ¥å—çš„å»¶è¿Ÿä¸Šé™? (10ms? 50ms? 200ms?)              â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â”‚                                    â”‚
â”‚                          â–¼                                    â”‚
â”‚   Step 2: åŸºå‡†æµ‹è¯•                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  ä½¿ç”¨ search_list = TopK æµ‹è¯•åŸºå‡†æ€§èƒ½                 â”‚    â”‚
â”‚   â”‚  è®°å½•: QPS, Latency, Recall                          â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â”‚                                    â”‚
â”‚                          â–¼                                    â”‚
â”‚   Step 3: äºŒåˆ†è°ƒä¼˜                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  if Recall < ç›®æ ‡:                                    â”‚    â”‚
â”‚   â”‚      search_list *= 1.5                              â”‚    â”‚
â”‚   â”‚  elif Latency > ç›®æ ‡:                                 â”‚    â”‚
â”‚   â”‚      search_list *= 0.8                              â”‚    â”‚
â”‚   â”‚  é‡å¤ç›´åˆ°æ»¡è¶³æ¡ä»¶                                      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â”‚                                    â”‚
â”‚                          â–¼                                    â”‚
â”‚   Step 4: éªŒè¯ä¸ä¸Šçº¿                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  é•¿æ—¶é—´å‹æµ‹éªŒè¯ç¨³å®šæ€§                                  â”‚    â”‚
â”‚   â”‚  ç›‘æ§ P99 å»¶è¿Ÿ                                        â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¸¸è§é—®é¢˜æ’æŸ¥

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| å¬å›ç‡ä½ | search_list å¤ªå° | å¢å¤§ search_list |
| å»¶è¿Ÿé«˜ | search_list å¤ªå¤§ | å‡å° search_list |
| QPS ä½ | SSD é€Ÿåº¦æ…¢ | ä½¿ç”¨ NVMe SSD |
| ç´¢å¼•æ„å»ºæ…¢ | æ•°æ®é‡å¤§ | å¢åŠ å†…å­˜ï¼Œä½¿ç”¨æ›´å¿« SSD |
| å†…å­˜æº¢å‡º | å‘é‡ç»´åº¦å¤ªé«˜ | è€ƒè™‘é™ç»´æˆ–ä½¿ç”¨æ›´å¤šå†…å­˜ |

### 5.3 ä¸åŒè§„æ¨¡æ¨èé…ç½®

| å‘é‡æ•° | ç»´åº¦ | å†…å­˜å»ºè®® | search_list å»ºè®® |
|--------|------|---------|-----------------|
| 1M | 128 | 8 GB | 100-200 |
| 1M | 960 | 16 GB | 100-150 |
| 10M | 128 | 16 GB | 150-250 |
| 100M | 128 | 32 GB | 150-300 |
| 1B | 128 | 64 GB | 200-400 |

---

## 6. å®Œæ•´ç¤ºä¾‹

### 6.1 å®Œæ•´çš„ DiskANN ä½¿ç”¨ç¤ºä¾‹

```python
"""
DiskANN å®Œæ•´ç¤ºä¾‹
"""

import numpy as np
from pymilvus import MilvusClient, DataType

# ========== é…ç½® ==========
MILVUS_URI = "http://localhost:19530"
COLLECTION_NAME = "diskann_demo"
DIMENSION = 128
NUM_VECTORS = 100000

# ========== è¿æ¥ ==========
client = MilvusClient(uri=MILVUS_URI)
print(f"Milvus ç‰ˆæœ¬: {client.get_server_version()}")

# ========== åˆ›å»º Collection ==========
if client.has_collection(COLLECTION_NAME):
    client.drop_collection(COLLECTION_NAME)

schema = client.create_schema(auto_id=False, enable_dynamic_field=False)
schema.add_field("id", DataType.INT64, is_primary=True)
schema.add_field("vector", DataType.FLOAT_VECTOR, dim=DIMENSION)
schema.add_field("category", DataType.VARCHAR, max_length=64)

index_params = client.prepare_index_params()
index_params.add_index(
    field_name="vector",
    index_type="DISKANN",
    metric_type="L2"
)

client.create_collection(
    collection_name=COLLECTION_NAME,
    schema=schema,
    index_params=index_params
)
print(f"âœ… åˆ›å»º Collection: {COLLECTION_NAME}")

# ========== æ’å…¥æ•°æ® ==========
BATCH_SIZE = 10000
categories = ["A", "B", "C", "D"]

for i in range(0, NUM_VECTORS, BATCH_SIZE):
    end = min(i + BATCH_SIZE, NUM_VECTORS)
    data = [
        {
            "id": j,
            "vector": np.random.random(DIMENSION).tolist(),
            "category": categories[j % len(categories)]
        }
        for j in range(i, end)
    ]
    client.insert(collection_name=COLLECTION_NAME, data=data)
    print(f"  æ’å…¥: {end}/{NUM_VECTORS}")

client.flush(collection_name=COLLECTION_NAME)
print("âœ… æ•°æ®æ’å…¥å®Œæˆ")

# ========== åŠ è½½ ==========
client.load_collection(COLLECTION_NAME)
print("âœ… Collection å·²åŠ è½½")

# ========== æœç´¢ ==========
query_vector = np.random.random(DIMENSION).tolist()
TOP_K = 10

# ä¸åŒ search_list å¯¹æ¯”
for sl in [10, 50, 100, 200]:
    search_params = {
        "metric_type": "L2",
        "params": {"search_list": sl}
    }
    
    results = client.search(
        collection_name=COLLECTION_NAME,
        data=[query_vector],
        limit=TOP_K,
        search_params=search_params,
        output_fields=["category"]
    )
    
    print(f"\nsearch_list={sl}:")
    for hit in results[0][:3]:
        print(f"  ID: {hit['id']}, Distance: {hit['distance']:.4f}, Category: {hit['entity']['category']}")

# ========== æ¸…ç† ==========
client.release_collection(COLLECTION_NAME)
client.drop_collection(COLLECTION_NAME)
client.close()
print("\nâœ… æ¸…ç†å®Œæˆ")
```

### 6.2 æ€§èƒ½æµ‹è¯•æ¨¡æ¿

```python
"""
DiskANN æ€§èƒ½æµ‹è¯•æ¨¡æ¿
"""

import time
import numpy as np
from pymilvus import MilvusClient

def benchmark_search(client, collection_name, queries, topK, search_list):
    """æµ‹è¯•æœç´¢æ€§èƒ½"""
    search_params = {
        "metric_type": "L2",
        "params": {"search_list": search_list}
    }
    
    # é¢„çƒ­
    for _ in range(5):
        client.search(collection_name=collection_name, data=[queries[0]], 
                     limit=topK, search_params=search_params)
    
    # æ­£å¼æµ‹è¯•
    start = time.time()
    for q in queries:
        client.search(collection_name=collection_name, data=[q], 
                     limit=topK, search_params=search_params)
    elapsed = time.time() - start
    
    qps = len(queries) / elapsed
    latency = (elapsed / len(queries)) * 1000
    
    return {"qps": qps, "latency_ms": latency}

# ä½¿ç”¨
# results = benchmark_search(client, "my_collection", query_list, topK=100, search_list=150)
# print(f"QPS: {results['qps']:.2f}, Latency: {results['latency_ms']:.2f}ms")
```

---

## å‚è€ƒèµ„æ–™

- [Milvus å®˜æ–¹æ–‡æ¡£](https://milvus.io/docs)
- [PyMilvus API æ–‡æ¡£](https://milvus.io/api-reference/pymilvus/v2.4.x/About.md)
- [DiskANN è®ºæ–‡](https://proceedings.neurips.cc/paper/2019/file/09853c7fb1d3f8ee67a61b6bf4a7f8e6-Paper.pdf)
- [ann-benchmarks](https://ann-benchmarks.com/)
